# -*- coding: utf-8 -*-
"""
@author: lakshya

--In this prototype we will provide the Q-Table values
--from the previous prototype and see how the new agent 
--performs when given information about a similar network

--The port scan only ranges from 1-100 right now but
--it provides a clear view of how the same can be 
--implemented for all the ports and different kinds of
--networks, hyperparameters for explorating needs to be
--adjusted because we there is a fair possibility of new
--vulnerabilities on the new network, so an optimal balance
--between exploration and exploitation parameters would enable
--the agent to explore even after identifying the vulnerabilities
--based on previous knowledge

#1-07-2023
"""

import os
import pandas as pd
import nmap
import numpy as np
import json
from fuzzywuzzy import fuzz

class NetworkEnv:
    def __init__(self, target_ip, target_ports, vulnerability_database_path):
        
        self.target_ip = target_ip
        self.target_ports = target_ports
        with open(vulnerability_database_path, 'r', encoding='utf-8') as file:
            self.vulnerability_database = json.load(file)
        self.current_port = 0
        self.nm = nmap.PortScanner()
        
    def load_vulnerability_database(self, filepath):
        with open(filepath, 'r') as file:
            data = json.load(dile)
        return data
    
    def step(self, action):
            info = {
                "Vulnerability":"",
                "Port":"",
            }
            reward = 0
            done = False
            
            
            #If the action is to scan
            if action == 0:
                print(f"Scanning port: {self.target_ports[self.current_port]}")
                result = self.nm.scan(self.target_ip, str(self.target_ports[self.current_port]), arguments='-sV')
                
                #Check for the service and the version
                service = result['scan'][self.target_ip]['tcp'][self.target_ports[self.current_port]]['name']
                version = result['scan'][self.target_ip]['tcp'][self.target_ports[self.current_port]]['version']
                
                #Check if they are in the vulnerability database
                for vuln in self.vulnerability_database:
                    service_similarity = fuzz.ratio(vuln['Service'].lower(), service.lower())
                    if service_similarity >= 80 and vuln['Version'] == version:
                        reward = 100
                        info = {"Vulnerability": vuln['CVE ID'], "Port": self.target_ports[self.current_port]}
                        print(f"Vulnerability found  CVE ID: {info['Vulnerability']} on Port: {info['Port']}")
                        break
                    else:
                        reward = -1
            else:
                #Action set to Do Not Scan
                reward = 0 #No penalty for skipping non-vulnerable port
            
            
            if self.current_port >= len(self.target_ports) - 1:
                done = True
            else:
                self.current_port += 1
            return self.current_port, reward, done, info
        
    def reset(self):
            self.current_port = 0
            return self.current_port
        
class QLAgent:
    #Changed alpha to 0.3 from 0.5 -- This defines by how much new information overrides old information
    #Tried discount factor (epsilon_decay) to 0.9 but that messe up the training
    def __init__(self, num_states, num_actions, alpha=0.3 , gamma=0.95, epsilon=1.0, epsilon_decay=0.995, epsilon_min=0.01):
        self.alpha = alpha
        self.gamma = gamma
        self.epsilon = epsilon
        self.epsilon_decay = epsilon_decay
        self.epsilon_min = epsilon_min
        self.num_actions = num_actions
        
        #Initialising Q-table to small random values
        self.q_table = np.random.uniform(low=-1, high=1, size=(num_states, num_actions))
        
    def get_action(self, state):
        if np.random.rand() <= self.epsilon:
            return np.random.choice(self.num_actions) #Exploration
        
        
        else:
            return np.argmax(self.q_table[state]) #Exploitation
    
    def update_q_values(self, state, action, reward, next_state):
        old_value = self.q_table[state, action]
        next_max = np.max(self.q_table[next_state])
        
        new_value = (1 - self.alpha) * old_value + self.alpha * (reward + self.gamma * next_max)
        self.q_table[state, action] = new_value
        
        if self.epsilon > self.epsilon_min:
            self.epsilon *= self.epsilon_decay
    @staticmethod    
    def load_q_table(filename):
        return np.load(filename)


# Environment Initialization
target_ip = '192.168.240.129'
target_ports = list(range(1,100)) # Port scan from 1 to 100
vulnerability_database_path = "vulnerability_database_2023.json" # Database containing known vulnerabilities
env = NetworkEnv(target_ip, target_ports, vulnerability_database_path)

num_states = len(target_ports)
num_actions = 2 # 0=Scan and 1=Don't scan
agent = QLAgent(num_states, num_actions)

total_rewards = []
episode_lengths = []

# Directly use the Q-tables
for i in range(40, 50):  # Adjust the range depending on the naming convention of your Q-table files
    q_table_filename = f"/home/foobanizer/Desktop/NVS/Q-Tables/q_table_{i}.npy"
    loaded_q_table = QLAgent.load_q_table(q_table_filename)

    # Update the agent's Q-table
    agent.q_table = loaded_q_table

    # Set agent to set a mix of exploration and exploitation
    agent.epsilon = 0.07 #We can adjust this value to balance exploration and exploitation

    for _ in range(50):
        total_reward = 0
        episode_length = 0
        state = env.reset()
    
    # Use the agent to make decisions
        for state in range(num_states):
            action = agent.get_action(state)
            next_state, reward, done, info = env.step(action)
            
            total_reward += reward
            episode_length += 1

            if done:
                #if info and 'Vulnerability' in info and 'Port' in info:
                #   print(f"Vulnerability found using Q-table from episode {i}: CVE ID:{'Vulnerability'} on Port: {'Port'}")
                break

            state = next_state

        total_rewards.append(total_reward)
        episode_lengths.append(episode_length)

print("Total rewards per episode: ", total_rewards)  
print("Episode lengths: ", episode_lengths)

"""
Scanning port: 15
Scanning port: 20
Scanning port: 21
Vulnerability found  CVE ID: CVE-2023-0003 (FTP) on Port: 21
Scanning port: 24
Scanning port: 50
Scanning port: 51
Scanning port: 53
Vulnerability found  CVE ID: CVE-2023-0003 (Domain) on Port: 53
Scanning port: 78
Scanning port: 79
Scanning port: 80
Vulnerability found  CVE ID: CVE-2023-0003 (HTTP) on Port: 80
Scanning port: 84
Scanning port: 1
Scanning port: 10
Scanning port: 15
Scanning port: 20
Scanning port: 21
Vulnerability found  CVE ID: CVE-2023-0003 (FTP) on Port: 21
Scanning port: 49
Scanning port: 50
Scanning port: 51
Scanning port: 53
Vulnerability found  CVE ID: CVE-2023-0003 (Domain) on Port: 53
Scanning port: 70
Scanning port: 75
Scanning port: 77
Scanning port: 78
Scanning port: 79
Scanning port: 80
Vulnerability found  CVE ID: CVE-2023-0003 (HTTP) on Port: 80
Scanning port: 99
Scanning port: 15
Scanning port: 20
Scanning port: 36
Scanning port: 39
Scanning port: 49
Scanning port: 50
Scanning port: 51
Scanning port: 53
Vulnerability found  CVE ID: CVE-2023-0003 (Domain) on Port: 53
Scanning port: 78
Scanning port: 79
Scanning port: 80
Vulnerability found  CVE ID: CVE-2023-0003 (HTTP) on Port: 80
Scanning port: 15
Scanning port: 20
Scanning port: 21
Vulnerability found  CVE ID: CVE-2023-0003 (FTP) on Port: 21
Scanning port: 29
Scanning port: 32
Scanning port: 49
Scanning port: 50
Scanning port: 51
Scanning port: 53
Vulnerability found  CVE ID: CVE-2023-0003 (Domain) on Port: 53
Scanning port: 54
Scanning port: 78
Scanning port: 79
Scanning port: 80
Vulnerability found  CVE ID: CVE-2023-0003 (HTTP) on Port: 80
Scanning port: 1
Scanning port: 19
Scanning port: 20
Scanning port: 21
Vulnerability found  CVE ID: CVE-2023-0003 (FTP) on Port: 21
Scanning port: 35
Scanning port: 49
Scanning port: 50
Scanning port: 51
Scanning port: 53
Vulnerability found  CVE ID: CVE-2023-0003 (Domain) on Port: 53
Scanning port: 56
Scanning port: 67
Scanning port: 78
Scanning port: 79
Scanning port: 80
Vulnerability found  CVE ID: CVE-2023-0003 (HTTP) on Port: 80
Scanning port: 11
Scanning port: 15
Scanning port: 20
Scanning port: 21
Vulnerability found  CVE ID: CVE-2023-0003 (FTP) on Port: 21
Scanning port: 49
Scanning port: 50
Scanning port: 51
Scanning port: 53
Vulnerability found  CVE ID: CVE-2023-0003 (Domain) on Port: 53
Scanning port: 70
Scanning port: 78
Scanning port: 79
Scanning port: 80
Vulnerability found  CVE ID: CVE-2023-0003 (HTTP) on Port: 80
Scanning port: 15
Scanning port: 20
Scanning port: 21
Vulnerability found  CVE ID: CVE-2023-0003 (FTP) on Port: 21
Scanning port: 29
Scanning port: 40
Scanning port: 49
Scanning port: 50
Scanning port: 51
Scanning port: 53
Vulnerability found  CVE ID: CVE-2023-0003 (Domain) on Port: 53
Scanning port: 79
Scanning port: 80
Vulnerability found  CVE ID: CVE-2023-0003 (HTTP) on Port: 80
Scanning port: 81
Scanning port: 97
Scanning port: 11
Scanning port: 15
Scanning port: 21
Vulnerability found  CVE ID: CVE-2023-0003 (FTP) on Port: 21
Scanning port: 44
Scanning port: 49
Scanning port: 50
Scanning port: 51
Scanning port: 53
Vulnerability found  CVE ID: CVE-2023-0003 (Domain) on Port: 53
Scanning port: 78
Scanning port: 79
Scanning port: 80
Vulnerability found  CVE ID: CVE-2023-0003 (HTTP) on Port: 80
Scanning port: 9
Scanning port: 15
Scanning port: 20
Scanning port: 21
Vulnerability found  CVE ID: CVE-2023-0003 (FTP) on Port: 21
Scanning port: 49
Scanning port: 50
Scanning port: 51
Scanning port: 53
Vulnerability found  CVE ID: CVE-2023-0003 (Domain) on Port: 53
Scanning port: 78
Scanning port: 79
Scanning port: 80
Vulnerability found  CVE ID: CVE-2023-0003 (HTTP) on Port: 80
Scanning port: 14
Scanning port: 15
Scanning port: 20
Scanning port: 21
Vulnerability found  CVE ID: CVE-2023-0003 (FTP) on Port: 21
Scanning port: 24
Scanning port: 49
Scanning port: 50
Scanning port: 51
Scanning port: 53
Vulnerability found  CVE ID: CVE-2023-0003 (Domain) on Port: 53
Scanning port: 78
Scanning port: 79
Scanning port: 80
Vulnerability found  CVE ID: CVE-2023-0003 (HTTP) on Port: 80
Scanning port: 94
Scanning port: 98
Scanning port: 15
Scanning port: 20
Scanning port: 21
Vulnerability found  CVE ID: CVE-2023-0003 (FTP) on Port: 21
Scanning port: 49
Scanning port: 50
Scanning port: 51
Scanning port: 52
Scanning port: 53
Vulnerability found  CVE ID: CVE-2023-0003 (Domain) on Port: 53
Scanning port: 61
Scanning port: 63
Scanning port: 78
Scanning port: 79
Scanning port: 80
Vulnerability found  CVE ID: CVE-2023-0003 (HTTP) on Port: 80
Scanning port: 86
Scanning port: 93
Scanning port: 6
Scanning port: 15
Scanning port: 20
Scanning port: 21
Vulnerability found  CVE ID: CVE-2023-0003 (FTP) on Port: 21
Scanning port: 49
Scanning port: 50
Scanning port: 51
Scanning port: 53
Vulnerability found  CVE ID: CVE-2023-0003 (Domain) on Port: 53
Scanning port: 78
Scanning port: 79
Scanning port: 80
Vulnerability found  CVE ID: CVE-2023-0003 (HTTP) on Port: 80
Scanning port: 15
Scanning port: 20
Scanning port: 21
Vulnerability found  CVE ID: CVE-2023-0003 (FTP) on Port: 21
Scanning port: 42
Scanning port: 49
Scanning port: 50
Scanning port: 51
Scanning port: 53
Vulnerability found  CVE ID: CVE-2023-0003 (Domain) on Port: 53
Scanning port: 79
Scanning port: 80
Vulnerability found  CVE ID: CVE-2023-0003 (HTTP) on Port: 80
Scanning port: 89
Scanning port: 15
Scanning port: 20
Scanning port: 21
Vulnerability found  CVE ID: CVE-2023-0003 (FTP) on Port: 21
Scanning port: 37
Scanning port: 49
Scanning port: 50
Scanning port: 51
Scanning port: 78
Scanning port: 79
Scanning port: 80
Vulnerability found  CVE ID: CVE-2023-0003 (HTTP) on Port: 80
Scanning port: 91
Scanning port: 15
Scanning port: 20
Scanning port: 21
Vulnerability found  CVE ID: CVE-2023-0003 (FTP) on Port: 21
Scanning port: 24
Scanning port: 49
Scanning port: 50
Scanning port: 51
Scanning port: 53
Vulnerability found  CVE ID: CVE-2023-0003 (Domain) on Port: 53
Scanning port: 78
Scanning port: 79
Scanning port: 80
Vulnerability found  CVE ID: CVE-2023-0003 (HTTP) on Port: 80
Scanning port: 81
Scanning port: 95
Scanning port: 1
Scanning port: 15
Scanning port: 20
Scanning port: 21
Vulnerability found  CVE ID: CVE-2023-0003 (FTP) on Port: 21
Scanning port: 44
Scanning port: 45
Scanning port: 50
Scanning port: 51
Scanning port: 53
Vulnerability found  CVE ID: CVE-2023-0003 (Domain) on Port: 53
Scanning port: 68
Scanning port: 79
Scanning port: 80
Vulnerability found  CVE ID: CVE-2023-0003 (HTTP) on Port: 80
Scanning port: 15
Scanning port: 19
Scanning port: 20
Scanning port: 21
Vulnerability found  CVE ID: CVE-2023-0003 (FTP) on Port: 21
Scanning port: 49
Scanning port: 50
Scanning port: 51
Scanning port: 53
Vulnerability found  CVE ID: CVE-2023-0003 (Domain) on Port: 53
Scanning port: 78
Scanning port: 79
Scanning port: 80
Vulnerability found  CVE ID: CVE-2023-0003 (HTTP) on Port: 80
Scanning port: 94
Scanning port: 15
Scanning port: 20
Scanning port: 21
Vulnerability found  CVE ID: CVE-2023-0003 (FTP) on Port: 21
Scanning port: 26
Scanning port: 38
Scanning port: 49
Scanning port: 51
Scanning port: 53
Vulnerability found  CVE ID: CVE-2023-0003 (Domain) on Port: 53
Scanning port: 66
Scanning port: 70
Scanning port: 78
Scanning port: 79
Scanning port: 80
Vulnerability found  CVE ID: CVE-2023-0003 (HTTP) on Port: 80
Scanning port: 82
Scanning port: 87
Scanning port: 15
Scanning port: 20
Scanning port: 21
Vulnerability found  CVE ID: CVE-2023-0003 (FTP) on Port: 21
Scanning port: 49
Scanning port: 50
Scanning port: 51
Scanning port: 53
Vulnerability found  CVE ID: CVE-2023-0003 (Domain) on Port: 53
Scanning port: 78
Scanning port: 79
Scanning port: 80
Vulnerability found  CVE ID: CVE-2023-0003 (HTTP) on Port: 80
Scanning port: 98
Scanning port: 6
Scanning port: 14
Scanning port: 15
Scanning port: 20
Scanning port: 21
Vulnerability found  CVE ID: CVE-2023-0003 (FTP) on Port: 21
Scanning port: 23
Scanning port: 49
Scanning port: 50
Scanning port: 51
Scanning port: 53
Vulnerability found  CVE ID: CVE-2023-0003 (Domain) on Port: 53
Scanning port: 69
Scanning port: 75
Scanning port: 78
Scanning port: 79
Scanning port: 80
Vulnerability found  CVE ID: CVE-2023-0003 (HTTP) on Port: 80
Scanning port: 15
Scanning port: 40
Scanning port: 49
Scanning port: 50
Scanning port: 51
Scanning port: 53
Vulnerability found  CVE ID: CVE-2023-0003 (Domain) on Port: 53
Scanning port: 78
Scanning port: 79
Scanning port: 80
Vulnerability found  CVE ID: CVE-2023-0003 (HTTP) on Port: 80
Scanning port: 5
Scanning port: 15
Scanning port: 20
Scanning port: 21
Vulnerability found  CVE ID: CVE-2023-0003 (FTP) on Port: 21
Scanning port: 29
Scanning port: 33
Scanning port: 34
Scanning port: 49
Scanning port: 50
Scanning port: 51
Scanning port: 53
Vulnerability found  CVE ID: CVE-2023-0003 (Domain) on Port: 53
Scanning port: 64
Scanning port: 78
Scanning port: 79
Scanning port: 80
Vulnerability found  CVE ID: CVE-2023-0003 (HTTP) on Port: 80
Scanning port: 84
Scanning port: 86
Scanning port: 99
Scanning port: 3
Scanning port: 15
Scanning port: 20
Scanning port: 21
Vulnerability found  CVE ID: CVE-2023-0003 (FTP) on Port: 21
Scanning port: 26
Scanning port: 49
Scanning port: 50
Scanning port: 51
Scanning port: 53
Vulnerability found  CVE ID: CVE-2023-0003 (Domain) on Port: 53
Scanning port: 78
Scanning port: 79
Scanning port: 80
Vulnerability found  CVE ID: CVE-2023-0003 (HTTP) on Port: 80
Scanning port: 15
Scanning port: 20
Scanning port: 21
Vulnerability found  CVE ID: CVE-2023-0003 (FTP) on Port: 21
Scanning port: 49
Scanning port: 50
Scanning port: 51
Scanning port: 53
Vulnerability found  CVE ID: CVE-2023-0003 (Domain) on Port: 53
Scanning port: 63
Scanning port: 77
Scanning port: 78
Scanning port: 79
Scanning port: 80
Vulnerability found  CVE ID: CVE-2023-0003 (HTTP) on Port: 80
Scanning port: 87
Scanning port: 8
Scanning port: 15
Scanning port: 20
Scanning port: 21
Vulnerability found  CVE ID: CVE-2023-0003 (FTP) on Port: 21
Scanning port: 42
Scanning port: 49
Scanning port: 50
Scanning port: 51
Scanning port: 53
Vulnerability found  CVE ID: CVE-2023-0003 (Domain) on Port: 53
Scanning port: 66
Scanning port: 78
Scanning port: 79
Scanning port: 80
Vulnerability found  CVE ID: CVE-2023-0003 (HTTP) on Port: 80
Scanning port: 81
Scanning port: 15
Scanning port: 20
Scanning port: 21
Vulnerability found  CVE ID: CVE-2023-0003 (FTP) on Port: 21
Scanning port: 28
Scanning port: 31
Scanning port: 35
Scanning port: 43
Scanning port: 49
Scanning port: 50
Scanning port: 51
Scanning port: 53
Vulnerability found  CVE ID: CVE-2023-0003 (Domain) on Port: 53
Scanning port: 72
Scanning port: 76
Scanning port: 78
Scanning port: 79
Scanning port: 80
Vulnerability found  CVE ID: CVE-2023-0003 (HTTP) on Port: 80
Scanning port: 94
Scanning port: 15
Scanning port: 20
Scanning port: 21
Vulnerability found  CVE ID: CVE-2023-0003 (FTP) on Port: 21
Scanning port: 49
Scanning port: 50
Scanning port: 51
Scanning port: 53
Vulnerability found  CVE ID: CVE-2023-0003 (Domain) on Port: 53
Scanning port: 78
Scanning port: 79
Scanning port: 80
Vulnerability found  CVE ID: CVE-2023-0003 (HTTP) on Port: 80
Scanning port: 5
Scanning port: 14
Scanning port: 15
Scanning port: 20
Scanning port: 21
Vulnerability found  CVE ID: CVE-2023-0003 (FTP) on Port: 21
Scanning port: 25
Scanning port: 49
Scanning port: 50
Scanning port: 51
Scanning port: 53
Vulnerability found  CVE ID: CVE-2023-0003 (Domain) on Port: 53
Scanning port: 68
Scanning port: 78
Scanning port: 79
Scanning port: 80
Vulnerability found  CVE ID: CVE-2023-0003 (HTTP) on Port: 80
Scanning port: 92
Scanning port: 4
Scanning port: 9
Scanning port: 15
Scanning port: 20
Scanning port: 21
Vulnerability found  CVE ID: CVE-2023-0003 (FTP) on Port: 21
Scanning port: 49
Scanning port: 50
Scanning port: 51
Scanning port: 53
Vulnerability found  CVE ID: CVE-2023-0003 (Domain) on Port: 53
Scanning port: 56
Scanning port: 63
Scanning port: 78
Scanning port: 79
Scanning port: 80
Vulnerability found  CVE ID: CVE-2023-0003 (HTTP) on Port: 80
Scanning port: 15
Scanning port: 20
Scanning port: 21
Vulnerability found  CVE ID: CVE-2023-0003 (FTP) on Port: 21
Scanning port: 49
Scanning port: 50
Scanning port: 51
Scanning port: 53
Vulnerability found  CVE ID: CVE-2023-0003 (Domain) on Port: 53
Scanning port: 61
Scanning port: 78
Scanning port: 79
Scanning port: 80
Vulnerability found  CVE ID: CVE-2023-0003 (HTTP) on Port: 80
Scanning port: 1
Scanning port: 15
Scanning port: 20
Scanning port: 21
Vulnerability found  CVE ID: CVE-2023-0003 (FTP) on Port: 21
Scanning port: 22
Scanning port: 31
Scanning port: 49
Scanning port: 50
Scanning port: 51
Scanning port: 53
Vulnerability found  CVE ID: CVE-2023-0003 (Domain) on Port: 53
Scanning port: 78
Scanning port: 79
Scanning port: 80
Vulnerability found  CVE ID: CVE-2023-0003 (HTTP) on Port: 80
"""
